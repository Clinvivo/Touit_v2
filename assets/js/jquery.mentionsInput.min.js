(function($,_,p){var q={BACKSPACE:8,TAB:9,RETURN:13,ESC:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,COMMA:188,SPACE:32,HOME:36,END:35};var r={triggerChar:'@',onDataRequest:$.noop,minChars:2,showAvatars:true,elastic:true,classes:{autoCompleteItemActive:"active"},templates:{wrapper:_.template('<div class="mentions-input-box"></div>'),autocompleteList:_.template('<div class="mentions-autocomplete-list"></div>'),autocompleteListItem:_.template('<li data-ref-id="<%= id %>" data-ref-type="<%= type %>" data-display="<%= display %>"><%= content %></li>'),autocompleteListItemAvatar:_.template('<img src="<%= avatar %>" />'),autocompleteListItemIcon:_.template('<div class="icon <%= icon %>"></div>'),mentionsOverlay:_.template('<div class="mentions"><div></div></div>'),mentionItemSyntax:_.template('@[<%= value %>](<%= type %>:<%= id %>)'),mentionItemHighlight:_.template('<strong><span><%= value %></span></strong>')}};var s={htmlEncode:function(a){return _.escape(a)},highlightTerm:function(a,b){if(!b&&!b.length){return a}return a.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+b+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")},setCaratPosition:function(a,b){if(a.createTextRange){var c=a.createTextRange();c.move('character',b);c.select()}else{if(a.selectionStart){a.focus();a.setSelectionRange(b,b)}else{a.focus()}}},rtrim:function(a){return a.replace(/\s+$/,"")}};var t=function(j){var k,elmInputBox,elmInputWrapper,elmAutocompleteList,elmWrapperBox,elmMentionsOverlay,elmActiveAutoCompleteItem;var l=[];var m={};var n=[];var o;j=$.extend(true,{},r,j);function initTextarea(){elmInputBox=$(k);if(elmInputBox.attr('data-mentions-input')=='true'){return}elmInputWrapper=elmInputBox.parent();elmWrapperBox=$(j.templates.wrapper());elmInputBox.wrapAll(elmWrapperBox);elmWrapperBox=elmInputWrapper.find('> div');elmInputBox.attr('data-mentions-input','true');elmInputBox.bind('keydown',onInputBoxKeyDown);elmInputBox.bind('keypress',onInputBoxKeyPress);elmInputBox.bind('input',onInputBoxInput);elmInputBox.bind('click',onInputBoxClick);elmInputBox.bind('blur',onInputBoxBlur);if(j.elastic){elmInputBox.elastic()}}function initAutocomplete(){elmAutocompleteList=$(j.templates.autocompleteList());elmAutocompleteList.appendTo(elmWrapperBox);elmAutocompleteList.delegate('li','mousedown',onAutoCompleteItemClick)}function initMentionsOverlay(){elmMentionsOverlay=$(j.templates.mentionsOverlay());elmMentionsOverlay.prependTo(elmWrapperBox)}function updateValues(){var e=getInputBoxValue();_.each(l,function(a){var b=j.templates.mentionItemSyntax(a);e=e.replace(a.value,b)});var f=s.htmlEncode(e);_.each(l,function(a){var b=_.extend({},a,{value:s.htmlEncode(a.value)});var c=j.templates.mentionItemSyntax(b);var d=j.templates.mentionItemHighlight(b);f=f.replace(c,d)});f=f.replace(/\n/g,'<br />');f=f.replace(/ {2}/g,'&nbsp; ');elmInputBox.data('messageText',e);elmMentionsOverlay.find('div').html(f)}function resetBuffer(){n=[]}function updateMentionsCollection(){var c=getInputBoxValue();l=_.reject(l,function(a,b){return!a.value||c.indexOf(a.value)==-1});l=_.compact(l)}function addMention(a){var b=getInputBoxValue();var c=new RegExp("\\"+j.triggerChar+o,"gi");c.exec(b);var d=c.lastIndex-o.length-1;var e=c.lastIndex;var f=b.substr(0,d);var g=b.substr(e,b.length);var h=(f+a.value).length+1;l.push(a);resetBuffer();o='';hideAutoComplete();var i=f+a.value+' '+g;elmInputBox.val(i);updateValues();elmInputBox.focus();s.setCaratPosition(elmInputBox[0],h)}function getInputBoxValue(){return $.trim(elmInputBox.val())}function onAutoCompleteItemClick(e){var a=$(this);var b=m[a.attr('data-uid')];addMention(b);return false}function onInputBoxClick(e){resetBuffer()}function onInputBoxBlur(e){hideAutoComplete()}function onInputBoxInput(e){updateValues();updateMentionsCollection();var a=_.lastIndexOf(n,j.triggerChar);if(a>-1){o=n.slice(a+1).join('');o=s.rtrim(o);_.defer(_.bind(doSearch,this,o))}}function onInputBoxKeyPress(e){if(e.keyCode!==q.BACKSPACE){var a=String.fromCharCode(e.which||e.keyCode);n.push(a)}}function onInputBoxKeyDown(e){if(e.keyCode==q.LEFT||e.keyCode==q.RIGHT||e.keyCode==q.HOME||e.keyCode==q.END){_.defer(resetBuffer);if(navigator.userAgent.indexOf("MSIE 9")>-1){_.defer(updateValues)}return}if(e.keyCode==q.BACKSPACE){n=n.slice(0,-1+n.length);return}if(!elmAutocompleteList.is(':visible')){return true}switch(e.keyCode){case q.UP:case q.DOWN:var a=null;if(e.keyCode==q.DOWN){if(elmActiveAutoCompleteItem&&elmActiveAutoCompleteItem.length){a=elmActiveAutoCompleteItem.next()}else{a=elmAutocompleteList.find('li').first()}}else{a=$(elmActiveAutoCompleteItem).prev()}if(a.length){selectAutoCompleteItem(a)}return false;case q.RETURN:case q.TAB:if(elmActiveAutoCompleteItem&&elmActiveAutoCompleteItem.length){elmActiveAutoCompleteItem.trigger('mousedown');return false}break}return true}function hideAutoComplete(){elmActiveAutoCompleteItem=null;elmAutocompleteList.empty().hide()}function selectAutoCompleteItem(a){a.addClass(j.classes.autoCompleteItemActive);a.siblings().removeClass(j.classes.autoCompleteItemActive);elmActiveAutoCompleteItem=a}function populateDropdown(f,g){elmAutocompleteList.show();var h=_.pluck(l,'value');g=_.reject(g,function(a){return _.include(h,a.name)});if(!g.length){hideAutoComplete();return}elmAutocompleteList.empty();var i=$("<ul>").appendTo(elmAutocompleteList).hide();_.each(g,function(a,b){var c=_.uniqueId('mention_');m[c]=_.extend({},a,{value:a.name});var d=$(j.templates.autocompleteListItem({'id':s.htmlEncode(a.id),'display':s.htmlEncode(a.name),'type':s.htmlEncode(a.type),'content':s.highlightTerm(s.htmlEncode((a.name)),f)})).attr('data-uid',c);if(b===0){selectAutoCompleteItem(d)}if(j.showAvatars){var e;if(a.avatar){e=$(j.templates.autocompleteListItemAvatar({avatar:a.avatar}))}else{e=$(j.templates.autocompleteListItemIcon({icon:a.icon}))}e.prependTo(d)}d=d.appendTo(i)});elmAutocompleteList.show();i.show()}function doSearch(b){if(b&&b.length&&b.length>=j.minChars){j.onDataRequest.call(this,'search',b,function(a){populateDropdown(b,a)})}else{hideAutoComplete()}}function resetInput(){elmInputBox.val('');l=[];updateValues()}return{init:function(a){k=a;initTextarea();initAutocomplete();initMentionsOverlay();resetInput();if(j.prefillMention){addMention(j.prefillMention)}},val:function(a){if(!_.isFunction(a)){return}var b=l.length?elmInputBox.data('messageText'):getInputBoxValue();a.call(this,b)},reset:function(){resetInput()},getMentions:function(a){if(!_.isFunction(a)){return}a.call(this,l)}}};$.fn.mentionsInput=function(b,c){var d=arguments;if(typeof b==='object'||!b){c=b}return this.each(function(){var a=$.data(this,'mentionsInput')||$.data(this,'mentionsInput',new t(c));if(_.isFunction(a[b])){return a[b].apply(this,Array.prototype.slice.call(d,1))}else if(typeof b==='object'||!b){return a.init.call(this,this)}else{$.error('Method '+b+' does not exist')}})}})(jQuery,_);